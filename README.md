# Go Stripe Payment API

  ![Go Version](https://img.shields.io/badge/Go-1.21-00ADD8?style=for-the-badge&logo=go)
  ![Stripe](https://img.shields.io/badge/Stripe-6772E5?style=for-the-badge&logo=stripe)
  ![PostgreSQL](https://img.shields.io/badge/PostgreSQL-4169E1?style=for-the-badge&logo=postgresql) 
  A robust backend API built in Go that simulates a complete e-commerce payment flow by integrating with the Stripe API. This project was developed as an in-depth study of software architecture, concurrency, external service integration, and Go development best practices.

## ‚ú® Features

  * **Full Product CRUD:** Endpoints to Create, Read, Update, and Delete products.
  * **Order Creation:** An endpoint to create a new order with multiple items and quantities, simulating a shopping cart.
  * **Stripe Integration:** Generates `PaymentIntents` based on the total order value.
  * **Webhook Handler:** A secure endpoint to receive and process events from Stripe (e.g., `payment_intent.succeeded`), updating the order status in the database.
  * **Clean Architecture:** Utilizes dependency injection to decouple the application layers (handlers, repositories, database).

## üõ†Ô∏è Tech Stack

  * Language: Go
  * Payment Gateway: Stripe API
  * Database: PostgreSQL
  * API Testing: Postman
  * HTTP Router: Gorilla Mux
  * Configuration: Environment variables with `godotenv`
  * Webhook Testing: Stripe CLI

## üèõÔ∏è Database Schema

  The database is composed of three main tables designed to handle products and multi-item orders. The relationships are established through foreign keys linking `order_items` to both `orders` and `products`.

  ![Database Schema Diagram](docs/db_schema.png)

  <details>
  <summary>Click to view the DBML source code used to generate this diagram</summary>

  ```dbml
  // DBML code for dbdiagram.io

  Table products {
    id int [pk, increment]
    name varchar(255) [not null]
    description text
    price_cents int [not null, note: 'CHECK(price_cents > 0)']
    created_at timestamptz [default: `now()`]
  }

  Table orders {
    id int [pk, increment]
    status varchar(50) [not null, default: 'pending']
    amount_cents int [not null]
    stripe_payment_intent_id varchar(255) [unique]
    created_at timestamptz [default: `now()`]
  }

  Table order_items {
    id int [pk, increment]
    order_id int [not null]
    product_id int [not null]
    quantity int [not null, note: 'CHECK(quantity > 0)']
    price_at_purchase_cents int [not null]
  }

  // Define relationships
  Ref: order_items.order_id > orders.id
  Ref: order_items.product_id > products.id
```

## üöÄ Getting Started

Follow these steps to get a local copy up and running.

### Prerequisites

  * [Go](https://go.dev/doc/install) (version 1.21 or higher)
  * [PostgreSQL](https://www.postgresql.org/download/) installed locally
  * [Stripe CLI](https://stripe.com/docs/stripe-cli)
  * A [Stripe](https://stripe.com) account

### 1. Clone the Repository

  ```bash
  git clone https://github.com/RotigoZ/stripe-api-go.git
  cd stripe-api-go
  ```

### 2. Set up Environment Variables

  Create a `.env` file in the project root by copying the example file.
  ```bash
  cp .env.example .env
  ```
  Now, edit the `.env` file with your Stripe keys and database configuration:
  ```env
  # Your Stripe API keys (in test mode)
  SECRET_KEY="sk_test_..."
  PUBLISHABLE_KEY="pk_test_..."

  # Webhook signing secret generated by `stripe listen`
  STRIPE_WEBHOOK_SECRET="whsec_..." 

  # Database Configuration (Example for PostgreSQL)
  DATABASE_URL="postgres://your_user:your_password@localhost:5432/your_db_name?sslmode=disable"
  ```

### 3. Install Dependencies
  ```bash
  go mod tidy
  ```

### 4. Prepare the Database
  Run the `schema.sql` script to create the `products`, `orders` and `order_items` tables in your database.

### 5. Run the API
  ```bash
  go run ./cmd/api/main.go
  ```
  The server will be running on `http://localhost:3000`.

### 6. Start the Webhook Forwarding

  In a **second terminal**, start the Stripe CLI to forward events to your local API.
  ```bash
  stripe listen --forward-to localhost:3000/webhooks/stripe
  ```
  *(Remember to copy the `whsec_...` key that this command generates into your `.env` file and restart your API!)*

## üïπÔ∏è API Usage (Endpoints)

  First, create a product for test purposes.

* **Endpoint:** `POST /products`
* **Request Body (JSON):**

    ```json
    {
      "name": "Product 1",
      "description": "This is product 1!",
      "price_cents": 5000
    }
    ```
* **cURL Example:**

    ```bash
    curl -X POST http://localhost:3000/products \
    -H "Content-Type: application/json" \
    -d '{ "name": "Product 1", "description": "This is product 1!", "price_cents": 5000 }'
    ```
* **Success Response:**

    ```
    Product created successfully!
    ```

  The main endpoint to test the flow is for creating orders.

### Create an Order

* **Endpoint:** `POST /orders`
* **Request Body (JSON):**
    ```json
    {
      "products": [
        { "product_id": 1, "quantity": 2 }
      ]
    }
    ```
* **cURL Example:**
    ```bash
    curl -X POST http://localhost:3000/orders \
    -H "Content-Type: application/json" \
    -d '{ "products": [{ "product_id": 1, "quantity": 2 }] }'
    ```
* **Success Response:**
    ```json
    {
      "clientSecret": "pi_..._secret_..."
    }
    ```

### Confirming the Payment (End-to-End Test)

  After creating an order, the API returns a `clientSecret`. To complete the payment flow and test the webhook, you must manually confirm this payment. This step simulates the action that a real frontend would perform using Stripe.js.

**1. Get the Payment Intent ID**

  From the response of the `POST /orders` request, copy the Payment Intent ID. It's the first part of the `clientSecret`, starting with `pi_...` and ending before _secret_.

**2. Confirm the Payment via Stripe's API**

  Using a tool like Postman or cURL, make a `POST` request directly to Stripe's API to confirm the payment.

  * **Endpoint:** `POST https://api.stripe.com/v1/payment_intents/YOUR_PAYMENT_INTENT_ID/confirm`
  * **Authorization:** Use your Stripe **Secret Key** (`sk_test_...`) as a Bearer Token.
  * **Body:** Set the body type to `x-www-form-urlencoded`. Add the following key-value pair: 
    * **Key:** `payment_method`
    * **Value:** `pm_card_visa`

  **cURL Example:**
  _Replace `YOUR_PAYMENT_INTENT_ID` and `YOUR_STRIPE_SECRET_KEY` with your actual values._
  ```bash
  curl -X POST https://api.stripe.com/v1/payment_intents/YOUR_PAYMENT_INTENT_ID/confirm \
    -u "YOUR_STRIPE_SECRET_KEY:" \
    -d payment_method=pm_card_visa
  ```

**3. Observe the Results**

After sending the confirmation request, you will see the full flow in action:
* **In your Stripe CLI terminal:** You will see the `payment_intent.succeeded` event being received from Stripe and forwarded to your API.
* **In your Go API terminal:** You will see the logs from your webhook handler processing the event.
* **In your database:** You can verify that the `status` of the corresponding order has been updated to `paid`.

## ‚úÖ Tests

This project does not yet have an automated test suite. Future work includes adding unit tests for the main business logic in the handlers and repositories to ensure code quality and prevent regressions.

## Future Improvement

* **User Authentication:** Implement JWT authentication for user-specific orders.
* **Frontend Application:** Build a client-side application to interact with the API.
* **Pagination:** Add pagination to the GET /products endpoint.